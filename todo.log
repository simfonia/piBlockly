æœ¬è¨ˆç•«æ˜¯æŠŠæˆ‘å€‘åœ¨BlocklyDuinoæ‰€é–‹ç™¼çš„ç©æœ¨(@BlocklyDuino_simfonia/*)ç§»æ¤åˆ°VS Codeçš„å»¶ä¼¸å¥—ä»¶ä¸­:
1.å› ç‚ºArduino IDE 2çš„æ ¸å¿ƒæ˜¯VS Codeæ‰€ç”¨çš„æ ¸å¿ƒï¼Œ
  æ‰€ä»¥VS Codeçš„å»¶ä¼¸å¥—ä»¶å¯ä»¥ç›´æ¥åœ¨Arduino IDE 2 ä¸­åŸ·è¡Œã€‚
2.åœ¨ VS Codeä¸­é–‹ç™¼é€™å€‹ç©æœ¨å¥—ä»¶ï¼Œæœ€å¾Œæ‰“åŒ…çµ¦Arduino IDE 2ç”¨
3.ç”¨æˆ‘å€‘é–‹ç™¼çš„é€™å€‹ç©æœ¨å¥—ä»¶(ä¹‹å¾Œç¨±ç‚ºÏ€Blockly)ç”¢ç”ŸArduino C++ç¨‹å¼çµ¦Arduino IDE 2çš„ç·¨è¼¯å™¨ï¼Œ
3.ç”¨æˆ‘å€‘é–‹ç™¼çš„é€™å€‹ç©æœ¨å¥—ä»¶(ä¹‹å¾Œç¨±ç‚ºÏ€Blockly)ç”¢ç”ŸArduino C++ç¨‹å¼çµ¦Arduino IDE 2çš„ç·¨è¼¯å™¨ï¼Œ
3.ç”¨æˆ‘å€‘é–‹ç™¼çš„é€™å€‹ç©æœ¨å¥—ä»¶(ä¹‹å¾Œç¨±ç‚ºÏ€Blockly)ç”¢ç”ŸArduino C++ç¨‹å¼çµ¦Arduino IDE 2çš„ç·¨è¼¯å™¨ï¼Œ
  å†å€Ÿç”±å®ƒçš„ä»‹é¢ç›´æ¥ä¸Šå‚³ï¼Œä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨å®ƒçš„å…¶å®ƒåŠŸèƒ½ï¼Œä¸ç”¨åƒå…¶å®ƒBlocklyç’°å¢ƒé‚£æ¨£äº’ç›¸åˆ‡æ›ã€‚
4.å°‡ä¾†æ‰“ç®—æŠŠç©æœ¨æ”¾åœ¨github pageä¸Šï¼Œè®“é€™å€‹å»¶ä¼¸å¥—ä»¶çš„ç©æœ¨å‹•æ…‹è¼‰å…¥

To do:
[ ] 0. ç§»æ¤ @BlocklyDuino_simfonia/*
[ ] 1. å®ŒæˆåŸºæœ¬C++èªæ³•ç©æœ¨
[ ] 2. è®“ä½¿ç”¨è€…å­˜å„²ã€é–‹å•Ÿå¯«å¥½çš„ç©æœ¨ç¨‹å¼
[ ] 3. ç¬¬ä¸‰æ–¹ç©æœ¨å¯ä»¥ç”±ç¶²é å‹•æ…‹è¼‰å…¥
[ ] 4. Webviewå®‰å…¨æ€§ç­–ç•¥å•é¡Œæª¢æŸ¥

---

### 2025-10-11 é€²åº¦è¨˜éŒ„

**å·²å®Œæˆäº‹é …:**
- [x] å»ºç«‹ VS Code æ“´å……åŠŸèƒ½å°ˆæ¡ˆ (`piblockly`)ã€‚
- [x] è§£æ±º VS Code ç‰ˆæœ¬ç›¸å®¹æ€§å•é¡Œã€‚
- [x] å»ºç«‹ Webview é¢æ¿ä½œç‚º Blockly çš„å®¹å™¨ã€‚
- [x] æˆåŠŸè¼‰å…¥ Blockly æ ¸å¿ƒå‡½å¼åº«ã€‚
- [x] è§£æ±ºå…§å®¹å®‰å…¨ç­–ç•¥ (CSP) å•é¡Œï¼Œå…è¨±è¼‰å…¥æœ¬åœ°è…³æœ¬ã€‚
- [x] å·²å°‡ `simfonia` å°ˆæ¡ˆçš„è‡ªè¨‚ç©æœ¨æª”æ¡ˆ (`blocks.js`, `javascript.js` (renamed to`generator.js`), `en.js`, `zh-hant.js`) è¤‡è£½åˆ° `media/custom/` ç›®éŒ„ä¸‹ã€‚
- [x] å·²å°‡ `toolbox.xml` çš„å…§å®¹æ•´åˆåˆ° Webview ä¸­ã€‚


**éç¨‹ä¸­å¯èƒ½æœƒé‡åˆ°çš„å•é¡Œ:**
1.å®˜æ–¹çš„ `blockly` å¥—ä»¶é è¨­ä¸åŒ…å« Arduino çš„ç¨‹å¼ç¢¼ç”¢ç”Ÿå™¨ã€‚
è§£æ±ºæ–¹æ¡ˆï¼š
[x] copy @package.nw/js/arduino_compressed.js åˆ° @piblockly/media ä¾†ä½¿ç”¨

2. ç›®å‰ä½¿ç”¨çš„Blocklyç‰ˆæœ¬(V12.3.1)å·²æŠŠFieldColour å’ŒFieldMultilineInputæ¬„ä½ç§»å‡ºæ ¸å¿ƒï¼Œæ”¹ç”¨pluginæ–¹å¼ä½¿ç”¨
è§£æ±ºæ–¹æ¡ˆï¼š
[x] å®‰è£npm install @blockly/field-colour @blockly/field-multilineinput
[x] å¾ŒçºŒä¿®æ”¹(å·²å®Œæˆ)
    - ç¢ºä¿ `node_modules` æ¸…æ½”ä¸”æ’ä»¶å·²å®‰è£ã€‚
    - æ›¿æ› `blockly_compressed.js` å’Œ `blocks_compressed.js` ç‚º cdnjs çš„æ¨™æº–ç‰ˆæœ¬ (`blockly.js`å’Œ `blocks.js`)ã€‚
    - ä¿®æ”¹ `extension.ts` ä»¥æ­£ç¢ºé †åºè¼‰å…¥æ’ä»¶è…³æœ¬ (`field-colour/dist/index.js`,`field-multilineinput/dist/index.js`) å’Œè‡ªè¨‚èªè¨€æª”æ¡ˆ (`custom/en.js`, `custom/zh-hant.js`)ã€‚
    - ä¿®æ”¹ `main.js`ï¼Œä½¿ç”¨ `Blockly.registry.register` æ­£ç¢ºè¨»å†Š `field_colour` å’Œ`field_multilineinput`ï¼Œä¸¦å¾ `window.FieldColour` å’Œ `window.Blockly.FieldColour`ï¼ˆæˆ–`window.Blockly.FieldColour` å’Œ `window.Blockly.FieldMultilineInput`ï¼‰ç²å–æ¬„ä½é¡åˆ¥ã€‚
    - ä¿®æ”¹ `blocks.js`ï¼Œå°‡åŒ…å« `FieldColour` å’Œ `FieldMultilineInput` çš„å€å¡Šï¼ˆä¾‹å¦‚`picar_set_led_color`ï¼Œ`coding_raw_statement` ç­‰ï¼‰è½‰æ›ç‚ºä½¿ç”¨ `jsonInit` æ–¹æ³•ã€‚


**å…¶ä»–å·²è§£æ±ºå•é¡Œ:**
- **å•é¡Œ:** `Refused to load media from
\'https://blockly-demo.appspot.com/static/media/click.mp3\'` (CSP error for media).\n  **
è§£æ±ºæ–¹æ¡ˆ:** åœ¨ `main.js` çš„ `Blockly.inject` é…ç½®ä¸­æ·»åŠ  `media: \'\'` å’Œ `sounds: false` ä»¥ç¦ç”¨Blockly éŸ³æ•ˆã€‚

- **å•é¡Œ:** `Uncaught TypeError: Toolbox should be an <xml> document.`\n  **è§£æ±ºæ–¹æ¡ˆ:** åœ¨
`extension.ts` ä¸­å°‡ `toolbox.xml` å…§å®¹ç”¨ `<xml>` æ¨™ç±¤åŒ…è£¹ã€‚

- **å•é¡Œ:** `Uncaught SyntaxError: Unexpected identifier \'category_simfonia\'` å’Œ `Uncaught
SyntaxError: Invalid or unexpected token`ã€‚\n  **è§£æ±ºæ–¹æ¡ˆ:** åœ¨ `extension.ts` ä¸­æ­£ç¢ºè½‰ç¾©
`toolboxXml` å…§å®¹ä¸­çš„é›™å¼•è™Ÿ (`\"`) å’Œæ›è¡Œç¬¦ï¼ˆ`\n`ã€`\r`ï¼‰ã€‚

- **å•é¡Œ:** `Uncaught TypeError: Blockly.Field.get is not a function` å’Œ `Unable to find
[field_multilineinput][field] in the registry.`\n  **è§£æ±ºæ–¹æ¡ˆ:** é€™äº›éŒ¯èª¤æ˜¯ç”±æ–¼
`blockly_compressed.js` ç‰ˆæœ¬å•é¡Œå°è‡´çš„ã€‚è§£æ±ºæ–¹æ¡ˆæ˜¯æ›¿æ›ç‚ºæ¨™æº–çš„ `blockly.js` å’Œ `blocks.js`
ï¼Œä¸¦ä½¿ç”¨ `Blockly.registry.register` è¨»å†Šæ¬„ä½ã€‚

- **å•é¡Œ:** \"ç©æœ¨é¸å–®ç„¡æ³•å‡ºç¾\" (Block menu cannot appear) å’Œ
\"ç©æœ¨æœ‰å‡ºç¾ï¼Œä½†åˆ‡æ›å­é¡åˆ¥å¾Œï¼Œå°±æœƒæ¶ˆå¤±\" (Blocks appear, but disappear after switching
subcategories)ã€‚\n  **è§£æ±ºæ–¹æ¡ˆ:** é€™äº›å•é¡Œæ˜¯ä¸Šè¿°éŒ¯èª¤çš„ç—‡ç‹€ï¼Œå·²éš¨ä¸Šè¿°è§£æ±ºæ–¹æ¡ˆä¸€ä½µè§£æ±ºã€‚\n-

**å•é¡Œ:** `blocks.js:4 Uncaught ReferenceError: module is not defined`ã€‚\n  **è§£æ±ºæ–¹æ¡ˆ:**
é€™æ˜¯ç”±æ–¼ `blocks.js` æª”æ¡ˆçš„ CommonJS æ ¼å¼èˆ‡ç€è¦½å™¨ç›´æ¥è¼‰å…¥ä¸å…¼å®¹ã€‚è§£æ±ºæ–¹æ¡ˆæ˜¯å°‡ `blocks.js`
æ›¿æ›ç‚ºæ¨™æº–çš„ `blocks_compressed.js` (å¾ cdnjs ä¸‹è¼‰ä¸¦é‡æ–°å‘½åç‚º `blocks.js`)ã€‚

 
å‚è€ƒæŒ‡å—ï¼š
ä¸€ã€åœ¨ Webview è£¡ä½¿ç”¨ Blockly çš„æ­£ç¢ºæ–¹å¼
âœ… Step 1ï¼šåœ¨ extension è£¡å»ºç«‹ä¸€å€‹ Webview

å‡è¨­ä½ çš„ extension.js æœ‰ä»¥ä¸‹å…§å®¹ï¼š

const vscode = require('vscode');
const path = require('path');
const fs = require('fs');

function activate(context) {
  context.subscriptions.push(
    vscode.commands.registerCommand('myblockly.show', () => {
      const panel = vscode.window.createWebviewPanel(
        'myBlocklyView',
        'Blockly Playground',
        vscode.ViewColumn.One,
        {
          enableScripts: true,   // âœ… å…è¨± Webview åŸ·è¡Œ JS
        }
      );

      const htmlPath = path.join(context.extensionPath, 'media', 'index.html');
      const htmlContent = fs.readFileSync(htmlPath, 'utf8');

      // âœ… æ›¿æ›æœ¬åœ°è³‡æºè·¯å¾‘æˆ webview å¯å­˜å–çš„ URI
      const webviewUri = panel.webview.asWebviewUri(
        vscode.Uri.file(path.join(context.extensionPath, 'media'))
      );

      panel.webview.html = htmlContent.replace(/{{baseUri}}/g, webviewUri.toString());
    })
  );
}

exports.activate = activate;

âœ… Step 2ï¼šåœ¨ media/index.html è£¡æ”¾ Blockly
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Blockly in VSCode</title>

  <!-- Blockly è³‡æºï¼šæ”¹ç”¨ Webview URI -->
  <script src="{{baseUri}}/blockly_compressed.js"></script>
  <script src="{{baseUri}}/blocks_compressed.js"></script>
  <script src="{{baseUri}}/javascript_compressed.js"></script>
  <script src="{{baseUri}}/msg/js/en.js"></script>
</head>
<body>
  <div id="blocklyDiv" style="height: 90vh; width: 100%;"></div>

  <xml id="toolbox" style="display: none">
    <block type="controls_if"></block>
    <block type="logic_compare"></block>
    <block type="text"></block>
  </xml>

  <script>
    const workspace = Blockly.inject('blocklyDiv', {
      toolbox: document.getElementById('toolbox'),
      media: '', // ä¸ç”¨å¤–éƒ¨éŸ³æ•ˆ
      sounds: false,
    });

    // âœ… Webview èˆ‡ Extension é€šè¨Š
    const vscode = acquireVsCodeApi();

    // ä¾‹å¦‚å‚³é€ Blockly ç¨‹å¼ç¢¼çµ¦ extension
    function sendCode() {
      const code = Blockly.JavaScript.workspaceToCode(workspace);
      vscode.postMessage({ type: 'code', code });
    }
  </script>
</body>
</html>

âš ï¸ äºŒã€é‡é»æ³¨æ„äº‹é …

æ‰€æœ‰è³‡æºå¿…é ˆæ˜¯æœ¬åœ°æª”æ¡ˆ (media è³‡æ–™å¤¾)ï¼Œä¸èƒ½è¼‰å¤–éƒ¨ CDNã€‚

VS Code Webview çš„ CSP é è¨­ç¦æ­¢å¤–éƒ¨é€£ç·šã€‚

æ‰€ä»¥åƒé€™ç¨®ï¼š

<script src="https://unpkg.com/blockly/blockly.min.js"></script>


âŒ ä¸å¯ç”¨ã€‚

è·¯å¾‘è¦é€é webview.asWebviewUri() è½‰æ›ã€‚
å› ç‚º Webview ä¸å…è¨±ç›´æ¥ä½¿ç”¨ file:///ã€‚

ä¸èƒ½ç”¨ require() æˆ– Node æ¨¡çµ„èªæ³•ã€‚
Webview è£¡æ²’æœ‰ Node.jsï¼Œåªèƒ½ç”¨ç´”å‰ç«¯ JSã€‚
â†’ æ‰€ä»¥ä½ çš„ Blockly block å®šç¾©æ‡‰è©²æ˜¯ç´”ç€è¦½å™¨ç‰ˆæœ¬ï¼ˆå…¨åŸŸ Blocklyï¼‰ã€‚

å‚³éè³‡æ–™è¦ç”¨ postMessage()ã€‚

Webview â†’ Extension: vscode.postMessage({ ... })

Extension â†’ Webview: panel.webview.postMessage({ ... })

è‹¥éœ€è¦ Pluginï¼ˆä¾‹å¦‚ field-multilineinputï¼‰
ä¹Ÿè¦æ”¾åœ¨ media è³‡æ–™å¤¾è£¡ï¼Œä¸¦ç”¨ç›¸å°è·¯å¾‘è¼‰å…¥ï¼š

<script src="{{baseUri}}/@blockly/field-multilineinput/dist/index.js"></script>
<script>
  Blockly.registry.register('field', 'field_multilineinput', window.FieldMultilineInput);
</script>

ğŸ§  ä¸‰ã€å°çµ
é …ç›®	åœ¨ç€è¦½å™¨ä¸­	åœ¨ VS Code Webview ä¸­
è³‡æºè¼‰å…¥	å¯ç”¨ CDN / file://	åªèƒ½ç”¨ webview.asWebviewUri()
æ¨¡çµ„èªæ³•	å¯ç”¨ ESM æˆ–å…¨åŸŸ	åªèƒ½å…¨åŸŸï¼ˆç„¡ Node æ¨¡çµ„ï¼‰
è²éŸ³ / å¤–éƒ¨ URL	å¯è¼‰å…¥	ç¦æ­¢ï¼ˆCSP é™åˆ¶ï¼‰
é€šè¨Šæ–¹å¼	ç„¡	ç”¨ postMessage()
Plugin ä½¿ç”¨	ç›´æ¥ <script>	åŒæ¨£æ”¾æœ¬åœ°ã€æ‰‹å‹•è¨»å†Š
ğŸš€ å››ã€ä½ å¯ä»¥é€™æ¨£æ¸¬è©¦

åœ¨ä½ çš„ extension å°ˆæ¡ˆä¸‹å»ºç«‹ï¼š

/media
  â”œâ”€ blockly_compressed.js
  â”œâ”€ blocks_compressed.js
  â”œâ”€ javascript_compressed.js
  â”œâ”€ msg/js/en.js
  â”œâ”€ index.html


åœ¨ package.json è£¡åŠ ä¸Šå‘½ä»¤ï¼š

"activationEvents": ["onCommand:myblockly.show"],
"contributes": {
  "commands": [
    {
      "command": "myblockly.show",
      "title": "Show Blockly"
    }
  ]
}


åœ¨ VS Code è£¡æŒ‰ F5 å•Ÿå‹•ã€Œé–‹ç™¼è€…æ¨¡å¼ã€ï¼ŒåŸ·è¡Œå‘½ä»¤ "Show Blockly"ã€‚
â†’ ä½ æ‡‰è©²æœƒçœ‹åˆ° Blockly æ­£å¸¸å‡ºç¾åœ¨ Webview è£¡ ğŸ‰